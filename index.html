<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Transaction Tracker</title>
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM for building the UI -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel for transpiling JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase CDN for database and authentication -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInAnonymously = signInAnonymously;
    window.onAuthStateChanged = onAuthStateChanged;
    window.GoogleAuthProvider = GoogleAuthProvider;
    window.signInWithPopup = signInWithPopup;
    window.signOut = signOut;
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.deleteDoc = deleteDoc;
    window.onSnapshot = onSnapshot;
    window.collection = collection;
    window.query = query;
    window.orderBy = orderBy;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
  </script>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;
    
    // Global variables provided by the Canvas environment for Firebase setup
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    const App = () => {
      // States for application data and Firebase
      const [transactions, setTransactions] = useState([]);
      const [type, setType] = useState('buy');
      const [cryptoAmount, setCryptoAmount] = useState('');
      const [fiatAmount, setFiatAmount] = useState('');
      const [date, setDate] = useState('');
      const [usdtEgpRate, setUsdtEgpRate] = useState(48.65678927);
      const [message, setMessage] = useState('');
      const [user, setUser] = useState(null);
      const [db, setDb] = useState(null);
      const [isLoading, setIsLoading] = useState(true);

      // Initialize Firebase and set up user authentication
      useEffect(() => {
        if (Object.keys(firebaseConfig).length === 0) {
          setMessage("Firebase config not available. Data will not be saved.");
          setIsLoading(false);
          return;
        }
        
        const app = window.initializeApp(firebaseConfig);
        const auth = window.getAuth(app);
        const firestore = window.getFirestore(app);
        setDb(firestore);
        
        console.log("Setting up authentication state listener...");
        
        let unsubscribeSnapshot = () => {};

        // Listen for authentication state changes
        const unsubscribeAuth = window.onAuthStateChanged(auth, (authUser) => {
          if (authUser) {
            console.log("User signed in:", authUser.uid);
            setUser(authUser);
            setIsLoading(false);

            // Set up a real-time listener for transactions
            const transactionsCollectionRef = window.collection(firestore, `artifacts/${appId}/users/${authUser.uid}/transactions`);
            const q = window.query(transactionsCollectionRef);

            unsubscribeSnapshot = window.onSnapshot(q, (querySnapshot) => {
              console.log("Fetching new transactions...");
              const fetchedTransactions = [];
              querySnapshot.forEach((doc) => {
                fetchedTransactions.push({ id: doc.id, ...doc.data() });
              });
              setTransactions(fetchedTransactions);
            }, (error) => {
              console.error("Error fetching data:", error);
              setMessage("Failed to load transactions.");
            });

          } else {
            console.log("User signed out.");
            setUser(null);
            setIsLoading(false);
            // Call the unsubscribe function when the user signs out
            unsubscribeSnapshot();
            setTransactions([]);
          }
        });

        // Cleanup function for the auth listener
        return () => {
          console.log("Cleaning up auth listener.");
          unsubscribeAuth();
          unsubscribeSnapshot();
        };
      }, []);

      const signInWithGoogle = async () => {
        const auth = window.getAuth();
        const provider = new window.GoogleAuthProvider();
        try {
          await window.signInWithPopup(auth, provider);
        } catch (error) {
          console.error("Error signing in with Google:", error);
          setMessage("Failed to sign in. Check the console.");
        }
      };

      const handleSignOut = async () => {
        const auth = window.getAuth();
        try {
          await window.signOut(auth);
          setTransactions([]);
        } catch (error) {
          console.error("Error signing out:", error);
          setMessage("Failed to sign out. Check the console.");
        }
      };

      const addTransaction = async (e) => {
        e.preventDefault();

        if (!cryptoAmount || !fiatAmount || !date) {
          setMessage('Please fill in all fields.');
          return;
        }

        setMessage('');

        const fiatValue = parseFloat(fiatAmount);
        const cryptoValue = parseFloat(cryptoAmount);
        const binanceFee = 0.05 * usdtEgpRate; // assuming a fixed 0.05% fee
        const bankFee = Math.max(0.5, fiatValue * 0.001);

        const newTransaction = {
          date: new Date(date).toLocaleDateString(),
          type: type,
          cryptoAmount: cryptoValue,
          fiatAmount: fiatValue,
          binanceFee: binanceFee,
          bankFee: bankFee,
          createdAt: new Date() // Add a timestamp
        };

        try {
          const transactionsCollectionRef = window.collection(db, `artifacts/${appId}/users/${user.uid}/transactions`);
          await window.addDoc(transactionsCollectionRef, newTransaction);
        } catch (error) {
          console.error("Error adding document:", error);
          setMessage("Failed to add transaction. Check the console.");
        }

        setCryptoAmount('');
        setFiatAmount('');
        setDate('');
      };

      const deleteTransaction = async (id) => {
        try {
          await window.deleteDoc(window.doc(db, `artifacts/${appId}/users/${user.uid}/transactions/${id}`));
        } catch (error) {
          console.error("Error deleting document:", error);
          setMessage("Failed to delete transaction. Check the console.");
        }
      };

      const downloadCsv = () => {
        if (transactions.length === 0) {
          setMessage('No transactions to download.');
          return;
        }
        
        const headers = ["Date", "Type", "Crypto Amount (USDT)", "Fiat Amount (EGP)", "Binance Fee (EGP)", "Bank Fee (EGP)", "Total Fees (EGP)"];
        
        const csvRows = transactions.map(tx => {
          const totalFees = (tx.binanceFee + tx.bankFee).toFixed(2);
          return [
            tx.date,
            tx.type.charAt(0).toUpperCase() + tx.type.slice(1),
            tx.cryptoAmount.toFixed(3),
            tx.fiatAmount.toFixed(2),
            tx.binanceFee.toFixed(2),
            tx.bankFee.toFixed(2),
            totalFees
          ].join(',');
        });
        
        const csvContent = [headers.join(','), ...csvRows].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "p2p_transactions.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const { totalProfit, netCrypto, totalBinanceFee, totalBankFee } = useMemo(() => {
        let totalFiatPaid = 0;
        let totalFiatReceived = 0;
        let totalCryptoBought = 0;
        let totalCryptoSold = 0;
        let totalBinanceFee = 0;
        let totalBankFee = 0;
        
        transactions.forEach(tx => {
          if (tx.type === 'buy') {
            totalFiatPaid += tx.fiatAmount + tx.binanceFee + tx.bankFee;
            totalCryptoBought += tx.cryptoAmount;
          } else {
            totalFiatReceived += tx.fiatAmount - tx.binanceFee - tx.bankFee;
            totalCryptoSold += tx.cryptoAmount;
          }
          totalBinanceFee += tx.binanceFee;
          totalBankFee += tx.bankFee;
        });

        const netCrypto = totalCryptoBought - totalCryptoSold;
        const totalProfit = totalFiatReceived - totalFiatPaid;

        return { totalProfit, netCrypto, totalBinanceFee, totalBankFee };
      }, [transactions]);
      
      if (isLoading) {
        return <div className="flex items-center justify-center min-h-screen">Loading...</div>;
      }
      
      if (!user) {
        return (
          <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4 font-sans antialiased">
            <div className="bg-white shadow-xl rounded-2xl p-6 sm:p-8 w-full max-w-sm text-center">
              <h1 className="text-2xl sm:text-3xl font-extrabold text-gray-800 tracking-tight mb-4">
                P2P Transaction Tracker
              </h1>
              <p className="text-gray-600 mb-6">
                Sign in to save and access your transactions from any device.
              </p>
              <button
                onClick={signInWithGoogle}
                className="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transform hover:scale-105 transition duration-300 ease-in-out flex items-center justify-center space-x-2"
              >
                <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                  <path fill="#FFC107" d="M43.6 20.4a20.0 20.0 0 0 1-3.6 12.3c-.6 1.3-1.4 2.5-2.4 3.6-2.4 2.4-5.2 3.6-8.2 3.7-3.6 0-7.2-1.3-10-3.6-2.8-2.3-4.5-5.6-4.5-9.3s1.7-7 4.5-9.3c2.8-2.3 6.4-3.6 10-3.6 3.8 0 7.4 1.4 10.3 4.1.3.2.7.5 1 .8.4.4.8.9 1.1 1.4.3.5.5 1 .7 1.6.2.6.3 1.2.3 1.8h-11.6v-2.4h11.6c-.2-1-.4-2-.7-3s-.6-2-.9-2.9c-.3-.9-.7-1.7-1.1-2.5-1.4-2.8-3.4-5.1-5.9-6.9-2.6-1.8-5.6-2.7-8.9-2.7-4.4 0-8.5 1.7-11.6 4.8-3.1 3.1-4.8 7.2-4.8 11.6s1.7 8.5 4.8 11.6c3.1 3.1 7.2 4.8 11.6 4.8 4.6 0 8.8-1.8 12-5.1 3.2-3.3 5-7.7 5.1-12.4h-1.2z"></path>
                  <path fill="#4285F4" d="M10.4 33.7c-2.4-2.4-3.6-5.2-3.6-8.2s1.2-5.8 3.6-8.2c2.4-2.4 5.2-3.6 8.2-3.6s5.8 1.2 8.2 3.6l3.6-3.6c-2.8-2.8-6.4-4.5-10.3-4.5s-7.5 1.7-10.3 4.5c-2.8 2.8-4.5 6.4-4.5 10.3s1.7 7.5 4.5 10.3c2.8 2.8 6.4 4.5 10.3 4.5s7.5-1.7 10.3-4.5l-3.6-3.6c-2.4 2.4-5.2 3.6-8.2 3.6s-5.8-1.2-8.2-3.6z"></path>
                  <path fill="#34A853" d="M24 44.8c-3.6 0-7.2-1.3-10-3.6-2.8-2.3-4.5-5.6-4.5-9.3s1.7-7 4.5-9.3c2.8-2.3 6.4-3.6 10-3.6 3.6 0 7.2 1.3 10 3.6l3.6-3.6c-2.8-2.8-6.4-4.5-10.3-4.5s-7.5 1.7-10.3 4.5c-2.8 2.8-4.5 6.4-4.5 10.3s1.7 7.5 4.5 10.3c2.8 2.8 6.4 4.5 10.3 4.5s7.5-1.7 10.3-4.5l-3.6-3.6c-2.4 2.4-5.2 3.6-8.2 3.6z"></path>
                  <path fill="#FBBC04" d="M43.6 20.4a20.0 20.0 0 0 1-3.6 12.3c-.6 1.3-1.4 2.5-2.4 3.6-2.4 2.4-5.2 3.6-8.2 3.7-3.6 0-7.2-1.3-10-3.6-2.8-2.3-4.5-5.6-4.5-9.3s1.7-7 4.5-9.3c2.8-2.3 6.4-3.6 10-3.6 3.8 0 7.4 1.4 10.3 4.1.3.2.7.5 1 .8.4.4.8.9 1.1 1.4.3.5.5 1 .7 1.6.2.6.3 1.2.3 1.8h-11.6v-2.4h11.6c-.2-1-.4-2-.7-3s-.6-2-.9-2.9c-.3-.9-.7-1.7-1.1-2.5-1.4-2.8-3.4-5.1-5.9-6.9-2.6-1.8-5.6-2.7-8.9-2.7-4.4 0-8.5 1.7-11.6 4.8-3.1 3.1-4.8 7.2-4.8 11.6s1.7 8.5 4.8 11.6c3.1 3.1 7.2 4.8 11.6 4.8 4.6 0 8.8-1.8 12-5.1 3.2-3.3 5-7.7 5.1-12.4h-1.2z"></path>
                  <path fill="#EA4335" d="M43.6 20.4a20.0 20.0 0 0 1-3.6 12.3c-.6 1.3-1.4 2.5-2.4 3.6-2.4 2.4-5.2 3.6-8.2 3.7-3.6 0-7.2-1.3-10-3.6-2.8-2.3-4.5-5.6-4.5-9.3s1.7-7 4.5-9.3c2.8-2.3 6.4-3.6 10-3.6 3.8 0 7.4 1.4 10.3 4.1.3.2.7.5 1 .8.4.4.8.9 1.1 1.4.3.5.5 1 .7 1.6.2.6.3 1.2.3 1.8h-11.6v-2.4h11.6c-.2-1-.4-2-.7-3s-.6-2-.9-2.9c-.3-.9-.7-1.7-1.1-2.5-1.4-2.8-3.4-5.1-5.9-6.9-2.6-1.8-5.6-2.7-8.9-2.7-4.4 0-8.5 1.7-11.6 4.8-3.1 3.1-4.8 7.2-4.8 11.6s1.7 8.5 4.8 11.6c3.1 3.1 7.2 4.8 11.6 4.8 4.6 0 8.8-1.8 12-5.1 3.2-3.3 5-7.7 5.1-12.4h-1.2z"></path>
                </svg>
                <span>Sign in with Google</span>
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4 font-sans antialiased">
          <div className="bg-white shadow-xl rounded-2xl p-6 sm:p-8 w-full max-w-4xl space-y-8">
            <div className="flex justify-between items-center">
              <h1 className="text-2xl sm:text-3xl font-extrabold text-gray-800 tracking-tight">
                P2P Transaction Tracker
              </h1>
              <button
                onClick={handleSignOut}
                className="text-sm font-medium text-red-500 hover:text-red-700 transition-colors duration-200"
              >
                Sign Out
              </butt
