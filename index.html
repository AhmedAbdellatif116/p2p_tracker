<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Transaction Tracker</title>
  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and ReactDOM for building the UI -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel for transpiling JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase CDN for database and auth -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, deleteDoc, onSnapshot, collection, query, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    window.initializeApp = initializeApp;
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.deleteDoc = deleteDoc;
    window.onSnapshot = onSnapshot;
    window.collection = collection;
    window.query = query;
    window.addDoc = addDoc;
    window.getAuth = getAuth;
    window.signInAnonymously = signInAnonymously;
    window.signInWithCustomToken = signInWithCustomToken;
    window.onAuthStateChanged = onAuthStateChanged;
  </script>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;
    
    // Global variables provided by the Canvas environment for Firebase setup
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const App = () => {
      // States for application data and Firebase
      const [transactions, setTransactions] = useState([]);
      const [type, setType] = useState('buy');
      const [cryptoAmount, setCryptoAmount] = useState('');
      const [fiatAmount, setFiatAmount] = useState('');
      const [date, setDate] = useState('');
      const [usdtEgpRate, setUsdtEgpRate] = useState(48.65678927);
      const [message, setMessage] = useState('');
      const [db, setDb] = useState(null);
      const [authReady, setAuthReady] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false); // New state to track submission

      // Initialize Firebase and set up the Firestore listener
      useEffect(() => {
        if (Object.keys(firebaseConfig).length === 0) {
          setMessage("Firebase config not available. Data will not be saved.");
          return;
        }
        
        const app = window.initializeApp(firebaseConfig);
        const auth = window.getAuth(app);
        const firestore = window.getFirestore(app);
        setDb(firestore);
        
        // Set up auth state listener to handle authentication
        const unsubscribeAuth = window.onAuthStateChanged(auth, async (user) => {
          if (user) {
            setAuthReady(true);
            
            // Set up a real-time listener for transactions once authenticated
            const transactionsCollectionRef = window.collection(firestore, `artifacts/${appId}/public/data/transactions`);
            const q = window.query(transactionsCollectionRef);
            
            const unsubscribeFirestore = window.onSnapshot(q, (querySnapshot) => {
              console.log("Fetching new transactions...");
              const fetchedTransactions = [];
              querySnapshot.forEach((doc) => {
                fetchedTransactions.push({ id: doc.id, ...doc.data() });
              });
              setTransactions(fetchedTransactions);
            }, (error) => {
              console.error("Error fetching data:", error);
              setMessage("Failed to load transactions.");
            });
            
            // Cleanup function for the Firestore listener
            return unsubscribeFirestore;
          } else {
            setAuthReady(true);
          }
        });
        
        // Sign in anonymously if no custom token is provided
        const signIn = async () => {
          try {
            if (initialAuthToken) {
              await window.signInWithCustomToken(auth, initialAuthToken);
            } else {
              await window.signInAnonymously(auth);
            }
          } catch (error) {
            console.error("Firebase Auth Error:", error);
            setMessage("Failed to authenticate with Firebase.");
          }
        };

        signIn();
        
        // Cleanup function for the auth listener
        return () => unsubscribeAuth();
      }, []);

      // Function to handle changes in fiat amount and calculate crypto
      const handleFiatChange = (e) => {
        const fiatValue = e.target.value;
        setFiatAmount(fiatValue);
        if (fiatValue && usdtEgpRate > 0) {
          setCryptoAmount((parseFloat(fiatValue) / usdtEgpRate).toFixed(3));
        } else {
          setCryptoAmount('');
        }
      };

      // Function to handle changes in crypto amount and calculate fiat
      const handleCryptoChange = (e) => {
        const cryptoValue = e.target.value;
        setCryptoAmount(cryptoValue);
        if (cryptoValue && usdtEgpRate > 0) {
          setFiatAmount((parseFloat(cryptoValue) * usdtEgpRate).toFixed(2));
        } else {
          setFiatAmount('');
        }
      };

      const addTransaction = async (e) => {
        e.preventDefault();

        if (!authReady) {
          setMessage('Authentication not ready. Please wait.');
          return;
        }
        
        if (isSubmitting) return; // Prevent multiple submissions

        if (!cryptoAmount || !fiatAmount || !date) {
          setMessage('Please fill in all fields.');
          return;
        }
        
        setIsSubmitting(true);
        setMessage('');

        const fiatValue = parseFloat(fiatAmount);
        const cryptoValue = parseFloat(cryptoAmount);
        
        // Binance fee is a fixed 0.05 USDT, converted to EGP
        const binanceFee = 0.05 * usdtEgpRate; 
        const bankFee = Math.max(0.5, fiatValue * 0.001);

        const newTransaction = {
          date: new Date(date).toLocaleDateString(),
          type: type,
          cryptoAmount: cryptoValue,
          fiatAmount: fiatValue,
          binanceFee: binanceFee,
          bankFee: bankFee,
          createdAt: new Date()
        };

        try {
          const transactionsCollectionRef = window.collection(db, `artifacts/${appId}/public/data/transactions`);
          await window.addDoc(transactionsCollectionRef, newTransaction);
          setMessage("Transaction added successfully!");
        } catch (error) {
          console.error("Error adding document:", error);
          // Log a more detailed error message to the console
          console.error("Firebase Error Code:", error.code);
          console.error("Firebase Error Message:", error.message);
          setMessage(`Failed to add transaction. Please check the console for details.`);
        } finally {
          setIsSubmitting(false);
        }

        setCryptoAmount('');
        setFiatAmount('');
        setDate('');
      };

      const deleteTransaction = async (id) => {
        if (!authReady) {
          setMessage('Authentication not ready. Please wait.');
          return;
        }
        
        try {
          await window.deleteDoc(window.doc(db, `artifacts/${appId}/public/data/transactions/${id}`));
        } catch (error) {
          console.error("Error deleting document:", error);
          setMessage("Failed to delete transaction. Check the console.");
        }
      };

      const downloadCsv = () => {
        if (transactions.length === 0) {
          setMessage('No transactions to download.');
          return;
        }
        
        const headers = ["Date", "Type", "Crypto Amount (USDT)", "Fiat Amount (EGP)", "Binance Fee (EGP)", "Bank Fee (EGP)", "Total Fees (EGP)"];
        
        const csvRows = transactions.map(tx => {
          const totalFees = (tx.binanceFee + tx.bankFee).toFixed(2);
          return [
            tx.date,
            tx.type.charAt(0).toUpperCase() + tx.type.slice(1),
            tx.cryptoAmount.toFixed(3),
            tx.fiatAmount.toFixed(2),
            tx.binanceFee.toFixed(2),
            tx.bankFee.toFixed(2),
            totalFees
          ].join(',');
        });
        
        const csvContent = [headers.join(','), ...csvRows].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "p2p_transactions.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const { totalProfit, netCrypto, totalBinanceFee, totalBankFee } = useMemo(() => {
        let totalFiatPaid = 0;
        let totalFiatReceived = 0;
        let totalCryptoBought = 0;
        let totalCryptoSold = 0;
        let totalBinanceFee = 0;
        let totalBankFee = 0;
        
        transactions.forEach(tx => {
          if (tx.type === 'buy') {
            totalFiatPaid += tx.fiatAmount + tx.binanceFee + tx.bankFee;
            totalCryptoBought += tx.cryptoAmount;
          } else {
            totalFiatReceived += tx.fiatAmount - tx.binanceFee - tx.bankFee;
            totalCryptoSold += tx.cryptoAmount;
          }
          totalBinanceFee += tx.binanceFee;
          totalBankFee += tx.bankFee;
        });

        const netCrypto = totalCryptoBought - totalCryptoSold;
        const totalProfit = totalFiatReceived - totalFiatPaid;

        return { totalProfit, netCrypto, totalBinanceFee, totalBankFee };
      }, [transactions]);
      
      return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4 font-sans antialiased">
          <div className="bg-white shadow-xl rounded-2xl p-6 sm:p-8 w-full max-w-4xl space-y-8">
            <div className="flex justify-between items-center">
              <h1 className="text-2xl sm:text-3xl font-extrabold text-gray-800 tracking-tight">
                P2P Transaction Tracker
              </h1>
            </div>
            
            <p className="text-center text-sm text-gray-500 break-words">
              Your unique ID is no longer displayed for privacy. Data is now saved to a public collection.
            </p>

            {/* Exchange Rate Section */}
            <div className="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
              <label htmlFor="usdtRate" className="text-gray-600 font-medium">
                USDT to EGP Exchange Rate
              </label>
              <input
                type="number"
                id="usdtRate"
                value={usdtEgpRate.toFixed(2)}
                onChange={(e) => setUsdtEgpRate(parseFloat(e.target.value))}
                className="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                step="0.01"
              />
            </div>

            {/* Transaction Form */}
            <form onSubmit={addTransaction} className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {/* Transaction Type */}
                <div>
                  <label className="block text-gray-700 font-semibold mb-2">Transaction Type</label>
                  <div className="flex rounded-lg overflow-hidden border border-gray-300">
                    <button
                      type="button"
                      onClick={() => setType('buy')}
                      className={`w-1/2 py-2 text-center font-medium transition duration-200 ${
                        type === 'buy' ? 'bg-green-500 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      Buy
                    </button>
                    <button
                      type="button"
                      onClick={() => setType('sell')}
                      className={`w-1/2 py-2 text-center font-medium transition duration-200 ${
                        type === 'sell' ? 'bg-red-500 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                      }`}
                    >
                      Sell
                    </button>
                  </div>
                </div>

                {/* Crypto Amount */}
                <div>
                  <label htmlFor="cryptoAmount" className="block text-gray-700 font-semibold mb-2">
                    Crypto Amount (USDT)
                  </label>
                  <input
                    type="number"
                    id="cryptoAmount"
                    value={cryptoAmount}
                    onChange={handleCryptoChange}
                    placeholder="e.g., 100"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    step="0.001"
                  />
                </div>
                
                {/* Fiat Amount */}
                <div>
                  <label htmlFor="fiatAmount" className="block text-gray-700 font-semibold mb-2">
                    Fiat Amount (EGP)
                  </label>
                  <input
                    type="number"
                    id="fiatAmount"
                    value={fiatAmount}
                    onChange={handleFiatChange}
                    placeholder="e.g., 5000"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                    step="0.01"
                  />
                </div>
                
                {/* Date Input */}
                <div>
                  <label htmlFor="date" className="block text-gray-700 font-semibold mb-2">
                    Transaction Date
                  </label>
                  <input
                    type="date"
                    id="date"
                    value={date}
                    onChange={(e) => setDate(e.target.value)}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                  />
                </div>
              </div>

              {/* Validation Message */}
              {message && (
                <div className="text-sm font-medium text-red-500 text-center">{message}</div>
              )}

              <button
                type="submit"
                disabled={isSubmitting}
                className={`w-full font-bold py-3 px-6 rounded-xl shadow-lg transform transition duration-300 ease-in-out ${
                  isSubmitting ? 'bg-gray-400 text-gray-600' : 'bg-blue-600 text-white hover:bg-blue-700 hover:scale-105'
                }`}
              >
                {isSubmitting ? 'Adding...' : 'Add Transaction'}
              </button>
            </form>

            {/* Summary and Table */}
            <div className="space-y-6">
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                {/* Total Profit/Loss */}
                <div className={`p-4 rounded-xl shadow-inner ${totalProfit >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                  <h3 className="font-semibold text-sm sm:text-base">Total Profit/Loss</h3>
                  <p className="font-bold text-xl sm:text-2xl mt-1">{totalProfit.toFixed(2)} EGP</p>
                </div>

                {/* Net Crypto Held */}
                <div className="p-4 rounded-xl shadow-inner bg-gray-100 text-gray-700">
                  <h3 className="font-semibold text-sm sm:text-base">Net Crypto Held</h3>
                  <p className="font-bold text-xl sm:text-2xl mt-1">{netCrypto.toFixed(3)} USDT</p>
                </div>
                
                {/* Total Binance Fees */}
                <div className="p-4 rounded-xl shadow-inner bg-gray-100 text-gray-700">
                  <h3 className="font-semibold text-sm sm:text-base">Total Binance Fees</h3>
                  <p className="font-bold text-xl sm:text-2xl mt-1">{totalBinanceFee.toFixed(2)} EGP</p>
                </div>
                
                {/* Total Bank Fees */}
                <div className="p-4 rounded-xl shadow-inner bg-gray-100 text-gray-700">
                  <h3 className="font-semibold text-sm sm:text-base">Total Bank Fees</h3>
                  <p className="font-bold text-xl sm:text-2xl mt-1">{totalBankFee.toFixed(2)} EGP</p>
                </div>
              </div>
              
              {/* Transactions Table */}
              <div className="overflow-x-auto rounded-lg shadow-md">
                <table className="min-w-full bg-white">
                  <thead className="bg-gray-200">
                    <tr>
                      <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Date</th>
                      <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Type</th>
                      <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Crypto (USDT)</th>
                      <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Fiat (EGP)</th>
                      <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Total Fees (EGP)</th>
                      <th className="py-3 px-4 text-left text-sm font-semibold text-gray-600 uppercase">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {transactions.length > 0 ? (
                      transactions.map((tx) => (
                        <tr key={tx.id} className="border-t border-gray-200 hover:bg-gray-50 transition-colors duration-150">
                          <td className="py-3 px-4 text-sm text-gray-800">{tx.date}</td>
                          <td className={`py-3 px-4 text-sm font-medium ${tx.type === 'buy' ? 'text-green-600' : 'text-red-600'}`}>
                            {tx.type.charAt(0).toUpperCase() + tx.type.slice(1)}
                          </td>
                          <td className="py-3 px-4 text-sm text-gray-800">{tx.cryptoAmount.toFixed(3)}</td>
                          <td className="py-3 px-4 text-sm text-gray-800">{tx.fiatAmount.toFixed(2)}</td>
                          <td className="py-3 px-4 text-sm text-gray-800">
                            {(tx.binanceFee + tx.bankFee).toFixed(2)}
                          </td>
                          <td className="py-3 px-4 text-sm text-gray-800">
                            <button
                              onClick={() => deleteTransaction(tx.id)}
                              className="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold hover:bg-red-600 transition-colors duration-200"
                            >
                              Delete
                            </button>
                          </td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="6" className="py-6 text-center text-gray-500 italic">
                          No transactions added yet.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
              <div className="text-center">
                <button
                  onClick={downloadCsv}
                  className="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-purple-700 transform hover:scale-105 transition duration-300 ease-in-out"
                >
                  Download as CSV
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };
    
    // Render the React component into the 'root' div
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

</body>
</html>
